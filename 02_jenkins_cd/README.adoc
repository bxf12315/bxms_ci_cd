:data-uri:
:toc2:
:rhtlink: link:https://www.redhat.com[Red Hat]

image::images/rhheader.png[width=900]

:numbered!:
[abstract]
== JBoss GPE Reference Architecture:  Template

:numbered:

== Abstract

== Overview

== Pre-Requisites

== Procedure

=== Docker accessibility
At start-up, Docker reverts its permissions so that only the `root` operating system user is authorized to execute `docker` commands.

In this lab, the pre-existing `jboss` should be allowed to execute `docker` commands.
The `jboss` user is already associated with the group: `dockerroot`.

Modify Docker permissions as follows such that those users in the `dockerroot` group are able to execute `docker` commands:

-----
sudo chgrp dockerroot /var/run/docker.sock
-----

NOTE:  This command will need to be executed every time the `docker` service is restarted (ie: when the host operating system is restarted).


=== Clone project
A clone of this project is already available on the `bxmscicd` virtual machine in the `jboss` operating system user's home directory: `$HOME/bxms_ci_cd`.
This section can be skipped if using the `bxmscicd` virtual machine.

If not using the `bxmscicd` virtual machine, this project can be cloned as follows:
 
-----
git clone https://github.com/jboss-gpe-ref-archs/bxms_ci_cd.git
-----

NOTE: For the purposes of this documentation, the name _$REF_ARCH_HOME_ refers to the root directory of this cloned project (ie: `$HOME/bxms_ci_cd` ).

=== Build Docker images
The `bxmcicd` virtual machine already includes all of the needed Docker images to support this project.
This section can be skipped if using the `bxmscicd` virtual machine.

If not using the `bxmscicd` virtual machine, this project can be cloned as follows:

. Change directories into the folder where the source code to the project's images reside:
+
-----
cd $REF_ARCH_HOME/02_jenkins_cd/docker/
-----
. Review the details of the project's build script:
+
-----
vi project_build.sh
-----
. Build BxMS CI / CD images
+
-----
./project_build.sh
-----

=== BxMS Storage image

. Start bxmcicd-storage container
+
-----
docker run -d --name=bxmscicd_storage bxmscicd-storage
-----
+
NOTE: After start-up, the `status` of the `bxmscicd-storage` container will be `Exited`.  
This is normal behavior as the container does not run an operating system process and is only used to attach to other running containers.

. Inspect mount paths of container volumes:
+
-----
docker inspect bxmscicd_storage
-----
+
In particular, review the mappings defined in the `Mounts` JSON array between the container `destination` and the `Source` directory on the host file system, ie:
+
-----
{
    "Destination": "/var/log/gitlab",
    "Driver": "local",
    "Mode": "",
    "Name": "b54ed365d3bf77312d68322858e81bc3a08df4899db285dfb80f77adf0f8e54a",
    "RW": true,
    "Source": "/var/lib/docker/volumes/b54ed365d3bf77312d68322858e81bc3a08df4899db285dfb80f77adf0f8e54a/_data"
},
-----

. View files (on host operating system) from mounted container volumes:
+
-----
sudo tree /var/lib/docker/volumes
-----

=== BxMS CI CD images

. If not already there, change directories to where the project's image source code resides:
+
-----
cd $REF_ARCH_HOME/02_jenkins_cd/docker/
-----
. Create and start `bxmscicd` containers from previously built images:
+
-----
docker-compose -p bpmscd up -d
-----

. View containers
+
-----
docker ps -a
-----

. Gain shell access to a running container
.. using `docker ps -a`, select the name of the container to gain shell access to. ie; `docker_nexus_1`
.. Execute:
+
-----
sudo nsenter -m -u -n -i -p -t `docker inspect --format '{{ .State.Pid }}' docker_nexus_1` /bin/bash
-----

. Stop containers
+
-----
docker-compose -p bpmscd stop
-----

. Delete all stopped containers
+
-----
docker rm $(docker ps -a -q)
-----

== Container Details

=== MySQL RDBMS

-----
mysql -h <fqdn> -u jboss -p bpmsdesign 
mysql -h <fqdn> -u jboss -p bpmstest
mysql -h <fqdn> -u jboss -p bpmsqa
mysql -h <fqdn> -u jboss -p bpmsprod
-----

Password for all of the above databases is: `jboss`

=== Web Containers

.Web container details
[width="100%",cols="1,2,4",options="header"]
|==============================================
|Container|URL|Server Log|User Credentials (userId / passwd)
|docker_nexus_1|<fqdn>:18080/nexus|/date/logs/nexus.log|admin / admin123
|docker_bpms-design_1|<fqdn>:28080/business-central||admin1 / admin
|docker_bpms-design_1|<fqdn>:28080/business-central||busadmin / busadmin
|docker_bpms-design_1|<fqdn>:28080/business-central||user1 / user
|docker_bpms-qa_1|<fqdn>:38080/kie-server/services/rest/server||admin1 / admin
|docker_bpms-prod_1|<fqdn>:48080/kie-server/services/rest/server||admin1 / admin
|docker_gitlab_1|<fqdn>:10080|/var/log/gitlab/gitlab/application.log|root / 5iveL!fe (password reset in Partner Demo System to: jb0ssredhat! )
|==============================================


== To-Do
. resolve this problem
. resolve that problem
=======

Prototype for ci/cd setup for JBoss BPMS

* bpms-design: user joe/joe. Roles=admin,analyst,user,kie-server,kiemgmt
* bpms-design: organizational unit 'acme'
* bpms-design: repository 'policyquote'
* local: repository 'policyquote' cloned from bpms.
* local: added .gitignore, set git user to joe@acme.org
* local: remote 'origin' renamed to 'bpms'
* gitlab: created user 'joe/redhat01'
* gitlab: uploaded ssh key 'id_rsa'
* gitlab: created group acme-insurance, member=joe
* local: added git remote for gitlab
+
----
$ git remote set-url origin ssh://git@localhost:10022/acme-insurance/policyquote.git
----
* jenkins: install plugin git-client, git, maven (update), workflow-aggregator
* gitlab: create project for workflow script
* nexus: add `http://download.devel.redhat.com/brewroot/repos/jb-bxms-6.2-build/latest/maven` repository
* nexus: added all repositories to public group
* jenkins image: configure git user settings
* gitlab: create user jenkins, add to group acme-insurance
* jenkins: create SSH key, added to Credentials plugin
* gitlab: uploaded jenkins SSH key
* note: bpms-runtime -> no support for quartz
* jenkins: when running script from git repo, sandboxed by default. Permissions must be set in http://172.17.1.128:8080/scriptApproval/
* gitlab: added webhook in policyquote project `http://172.17.1.151:8080/git/notifyCommit?url=ssh://git@gitlab/acme-insurance/policyquote.git`

In my setup I also use data volume containers - this allows me to respawn the docker images without losing the setup and data. The way I set this up:
* comment volumes-from statements in docker-compose.yml
* build the images : docker-compose -p bpmscd build
* smoke test the images
* if ok, create data volume containers for the images that require it, using the same image , eg:
docker create --name=bpmscd_mysql-bpms_data --volume=/var/lib/mysql/data bpmscd_mysql-bpms
* uncomment the volumes-from statements in docker-compose.yml
* launch the docker images : docker-compose -p bpmscd up -d

